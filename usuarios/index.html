<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Usuário • Gestão de viagens</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script>
      window.APP_PATH = "/frete-avulso-front";
      window.API_URL =
        location.hostname === "localhost" || location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : "https://frete-avulso-back.onrender.com";
    </script>
    <script src="../auth.js"></script>
    <script>
      (async () => {
        await window.__AUTH__.requireAuth();
      })();
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../dark.css" />
    <link rel="stylesheet" href="../public/header.css" />

    <style>
      :root {
        --card-radius: 16px;
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.08);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.14);
      }
      [data-bs-theme="dark"] {
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.45);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.6);
      }

      main {
        margin-top: var(--app-header-h, 64px);
      }

      .page-wrap {
        padding-block: clamp(16px, 2.5vw, 28px);
        max-width: 880px;
      }
      .page-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .page-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .hint {
        color: var(--bs-secondary-color);
      }

      .sheet {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
        transition: box-shadow 0.2s ease;
      }
      .sheet:hover {
        box-shadow: var(--shadow-2);
      }
      .sheet-header {
        padding: 1rem 1.25rem 0.75rem;
        border-bottom: 1px dashed var(--bs-border-color);
      }
      .sheet-body {
        padding: 1rem 1.25rem 1.25rem;
      }

      .form-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 768px) {
        .form-grid {
          grid-template-columns: repeat(12, 1fr);
        }
        .col-span-6 {
          grid-column: span 6;
        }
        .col-span-12 {
          grid-column: span 12;
        }
      }

      .form-control:focus,
      .form-select:focus {
        border-color: rgba(var(--bs-primary-rgb), 0.45);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
      }
      .error {
        display: block;
        color: var(--bs-danger-text);
        margin-top: 0.25rem;
      }

      .role-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .role-group .btn {
        border: 1px solid var(--bs-border-color);
      }
      .role-group .btn-check:checked + .btn {
        border-color: rgba(var(--bs-primary-rgb), 0.55);
        box-shadow: 0 0 0 0.15rem rgba(var(--bs-primary-rgb), 0.25);
      }

      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--bs-border-color);
        border-bottom-left-radius: var(--card-radius);
        border-bottom-right-radius: var(--card-radius);
        background: var(--bs-body-bg);
      }

      :focus {
        outline: 2px solid
          color-mix(in srgb, var(--bs-primary), transparent 55%);
        outline-offset: 2px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      button[aria-disabled="true"] {
        pointer-events: none;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <a class="visually-hidden-focusable" href="#main">Pular para o conteúdo</a>

    <main
      id="main"
      class="container page-wrap"
      role="main"
      tabindex="-1"
      aria-labelledby="page-title"
    >
      <div id="form-alert" class="mb-3" aria-live="assertive"></div>

      <div class="page-head">
        <div class="page-title h4 m-0" id="page-title">
          <i class="bi bi-person-plus"></i>
          <span>Cadastro de Usuário</span>
        </div>
        <div class="hint d-none d-md-block">Crie um novo acesso ao sistema</div>
      </div>

      <section class="sheet">
        <div class="sheet-header">
          <h2 class="h6 m-0">Dados do usuário</h2>
        </div>

        <div class="sheet-body">
          <form id="userForm" novalidate aria-describedby="form-alert">
            <div class="form-grid">
              <div class="col-span-6">
                <label for="nome" class="form-label">Nome completo</label>
                <input
                  type="text"
                  class="form-control"
                  id="nome"
                  name="nome"
                  required
                  placeholder="Digite o nome"
                  autocomplete="name"
                  aria-describedby="usernameError"
                />
                <span
                  id="usernameError"
                  class="error"
                  aria-live="polite"
                ></span>
              </div>

              <div class="col-span-6">
                <label for="cpf" class="form-label">CPF</label>
                <input
                  type="text"
                  class="form-control"
                  id="cpf"
                  name="cpf"
                  required
                  placeholder="000.000.000-00"
                  autocomplete="off"
                  maxlength="14"
                  inputmode="numeric"
                  oninput="formatarCPF(this)"
                  aria-describedby="cpfError"
                />
                <span id="cpfError" class="error" aria-live="polite"></span>
              </div>

              <div class="col-span-12">
                <label for="email" class="form-label">E-mail</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                  placeholder="email@exemplo.com"
                  autocomplete="email"
                  aria-describedby="emailError"
                />
                <span id="emailError" class="error" aria-live="polite"></span>
              </div>

              <div class="col-span-6">
                <label for="senha" class="form-label">Senha</label>
                <input
                  type="password"
                  class="form-control"
                  id="senha"
                  name="senha"
                  required
                  placeholder="Senha"
                  autocomplete="new-password"
                  aria-describedby="passwordError"
                />
                <span
                  id="passwordError"
                  class="error"
                  aria-live="polite"
                ></span>
              </div>

              <div class="col-span-6">
                <label for="confirmasenha" class="form-label"
                  >Confirmar senha</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmasenha"
                  name="confirmasenha"
                  required
                  placeholder="Repita a senha"
                  autocomplete="new-password"
                  aria-describedby="confirmPasswordError"
                />
                <span
                  id="confirmPasswordError"
                  class="error"
                  aria-live="polite"
                ></span>
              </div>

              <div class="col-span-12">
                <label class="form-label d-block" id="fun-role-label"
                  >Função</label
                >
                <div
                  class="role-group"
                  role="radiogroup"
                  aria-labelledby="fun-role-label"
                >
                  <input
                    type="radio"
                    class="btn-check"
                    name="gridRadios"
                    id="administrador"
                    value="administrador"
                    checked
                  />
                  <label
                    class="btn btn-sm btn-outline-secondary"
                    for="administrador"
                  >
                    <i class="bi bi-shield-lock"></i> Administrador
                  </label>

                  <input
                    type="radio"
                    class="btn-check"
                    name="gridRadios"
                    id="administrativo"
                    value="administrativo"
                  />
                  <label
                    class="btn btn-sm btn-outline-secondary"
                    for="administrativo"
                  >
                    <i class="bi bi-briefcase"></i> Administrativo
                  </label>
                </div>
              </div>
            </div>

            <div class="actions">
              <button
                type="reset"
                class="btn btn-outline-secondary"
                onclick="document.getElementById('userForm').reset()"
              >
                Limpar
              </button>
              <button
                type="submit"
                id="submitBtn"
                class="btn btn-primary"
                aria-label="Cadastrar usuário"
              >
                <span
                  class="sr-only"
                  id="submitStatus"
                  aria-live="polite"
                ></span>
                Cadastrar
              </button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <script>
      (function initTheme() {
        const isDark = sessionStorage.getItem("darktheme") === "true";
        document.body.setAttribute("data-bs-theme", isDark ? "dark" : "light");
      })();

      function showAlert(container, tipo, mensagem) {
        const w = document.createElement("div");
        w.innerHTML = [
          `<div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center" role="alert" aria-atomic="true" tabindex="-1">`,
          `  <div>${mensagem}</div>`,
          `  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`,
          `</div>`,
        ].join("");
        const el = w.firstChild;
        container.innerHTML = "";
        container.append(el);
        el.focus();
      }

      function formatarCPF(campo) {
        campo.value = campo.value
          .replace(/[^\d]/g, "")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      }

      function setFieldError(inputId, msgId, msg) {
        const input = document.getElementById(inputId);
        const span = document.getElementById(msgId);
        if (msg) {
          input.setAttribute("aria-invalid", "true");
          span.textContent = msg;
        } else {
          input.removeAttribute("aria-invalid");
          span.textContent = "";
        }
      }

      function validateForm() {
        const username = document.getElementById("nome").value.trim();
        const email = document.getElementById("email").value.trim();
        const cpf = document.getElementById("cpf").value.trim();
        const password = document.getElementById("senha").value;
        const confirm = document.getElementById("confirmasenha").value;
        let first = null;

        if (username.length < 3) {
          setFieldError(
            "nome",
            "usernameError",
            "Nome deve ter ao menos 3 caracteres."
          );
          first = first || "nome";
        } else setFieldError("nome", "usernameError", "");

        const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRx.test(email)) {
          setFieldError("email", "emailError", "E-mail inválido.");
          first = first || "email";
        } else setFieldError("email", "emailError", "");

        const cpfRx = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
        if (!cpfRx.test(cpf)) {
          setFieldError("cpf", "cpfError", "CPF inválido. Use 000.000.000-00.");
          first = first || "cpf";
        } else setFieldError("cpf", "cpfError", "");

        if (password.length < 6) {
          setFieldError(
            "senha",
            "passwordError",
            "Senha deve ter ao menos 6 caracteres."
          );
          first = first || "senha";
        } else setFieldError("senha", "passwordError", "");

        if (confirm !== password) {
          setFieldError(
            "confirmasenha",
            "confirmPasswordError",
            "As senhas não correspondem."
          );
          first = first || "confirmasenha";
        } else setFieldError("confirmasenha", "confirmPasswordError", "");

        if (first) {
          document.getElementById(first).focus();
          return false;
        }
        return true;
      }

      function setBusy(busy) {
        const form = document.getElementById("userForm");
        const btn = document.getElementById("submitBtn");
        const s = document.getElementById("submitStatus");
        if (busy) {
          form.setAttribute("aria-busy", "true");
          btn.setAttribute("aria-disabled", "true");
          s.textContent = "Enviando…";
        } else {
          form.removeAttribute("aria-busy");
          btn.removeAttribute("aria-disabled");
          s.textContent = "";
        }
      }

      document
        .getElementById("userForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!validateForm()) return;

          const payload = {
            nome: document.getElementById("nome").value.trim(),
            cpf: document.getElementById("cpf").value.replace(/[^\d]/g, ""),
            email: document.getElementById("email").value.trim(),
            senha: document.getElementById("senha").value,
            funcao: document.querySelector("input[name='gridRadios']:checked")
              ?.value,
          };

          setBusy(true);
          try {
            const r = await window.__AUTH__.callApi("/usuario", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (r.status === 401) {
              alert("login expirado");
              window.__AUTH__.goTo("/login");
              return;
            }

            if (!r.ok) {
              let msg = "Erro ao salvar.";
              try {
                const j = await r.json();
                if (j?.message) msg = j.message;
              } catch {}
              showAlert(document.getElementById("form-alert"), "warning", msg);
              return;
            }

            showAlert(
              document.getElementById("form-alert"),
              "success",
              "Usuário cadastrado com sucesso."
            );
            document.getElementById("userForm").reset();
          } catch {
            showAlert(
              document.getElementById("form-alert"),
              "danger",
              "Erro de rede. Tente novamente."
            );
          } finally {
            setBusy(false);
          }
        });
    </script>

    <script src="../public/header.js" defer></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
