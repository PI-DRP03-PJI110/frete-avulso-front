<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Dashboards • Gestão de viagens</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script>
      window.APP_PATH = "/frete-avulso-front";
      window.API_URL =
        location.hostname === "localhost" || location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : "https://frete-avulso-back.onrender.com";
    </script>
    <script src="../auth.js"></script>
    <script>
      (async () => {
        await window.__AUTH__.requireAuth();
      })();
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../dark.css" />
    <link rel="stylesheet" href="../public/header.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --card-radius: 16px;
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.08);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.14);
      }
      [data-bs-theme="dark"] {
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.45);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.6);
      }

      main {
        margin-top: var(--app-header-h, 64px);
      }
      .page-wrap {
        max-width: 1200px;
        padding-block: clamp(16px, 2.5vw, 28px);
      }

      .page-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .page-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin: 0;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .title-icon {
        display: inline-grid;
        place-items: center;
        width: 34px;
        height: 34px;
        border-radius: 8px;
        background: color-mix(in srgb, var(--bs-primary), transparent 86%);
        border: 1px solid var(--bs-border-color);
      }
      .page-subtle {
        color: var(--bs-secondary-color);
        margin-left: 42px;
      }

      .kpi-grid {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: 1fr 1fr;
      }
      @media (min-width: 768px) {
        .kpi-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      .kpi {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 0.85rem 1rem;
        box-shadow: var(--shadow-1);
      }
      .kpi .label {
        color: var(--bs-secondary-color);
        font-size: 0.85rem;
      }
      .kpi .value {
        font-weight: 700;
        font-size: 1.15rem;
        letter-spacing: -0.01em;
      }

      .dash-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 992px) {
        .dash-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (min-width: 1400px) {
        .dash-grid {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }

      .dash-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
        overflow: hidden;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
      }
      .dash-card:hover {
        box-shadow: var(--shadow-2);
        transform: translateY(-2px);
      }

      .dash-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.9rem 1rem;
        border-bottom: 1px dashed var(--bs-border-color);
      }
      .dash-title {
        font-weight: 600;
      }

      .chart-wrap {
        position: relative;
        width: 100%;
        aspect-ratio: 16/10;
        padding: 0.5rem;
      }
      .chart-wrap canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .table-wrap {
        padding: 0.5rem 1rem 1rem;
      }
      .table thead th {
        white-space: nowrap;
      }
      .table tbody td {
        vertical-align: middle;
      }

      .skeleton {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 1rem;
      }
      .skeleton .placeholder {
        height: 1.25rem;
      }

      :focus {
        outline: 2px solid
          color-mix(in srgb, var(--bs-primary), transparent 55%);
        outline-offset: 2px;
      }

      @media print {
        .d-print-none {
          display: none !important;
        }
        .dash-grid {
          grid-template-columns: 1fr !important;
        }
        .dash-card {
          box-shadow: none;
          border-color: #999;
        }
      }
    </style>
  </head>
  <body>
    <a class="visually-hidden-focusable" href="#main">Pular para o conteúdo</a>

    <main
      id="main"
      class="container page-wrap"
      role="main"
      tabindex="-1"
      aria-labelledby="page-title"
    >
      <div class="page-head">
        <h1 id="page-title" class="page-title h4">
          <span class="title-icon" aria-hidden="true"
            ><i class="bi bi-speedometer2"></i
          ></span>
          Dashboards
        </h1>
        <div class="d-print-none">
          <button
            class="btn btn-outline-secondary btn-sm"
            onclick="window.print()"
            aria-label="Imprimir"
          >
            <i class="bi bi-printer"></i>
          </button>
        </div>
      </div>
      <p class="page-subtle mb-3">
        Visão rápida: desempenho, custos e receita.
      </p>

      <section class="kpi-grid mb-3" id="kpi-grid">
        <div class="kpi">
          <div class="label">Viagens</div>
          <div class="value" id="kpi-viagens">-</div>
        </div>
        <div class="kpi">
          <div class="label">Receita</div>
          <div class="value" id="kpi-receita">-</div>
        </div>
        <div class="kpi">
          <div class="label">Custos</div>
          <div class="value" id="kpi-custos">-</div>
        </div>
        <div class="kpi">
          <div class="label">Margem / Ticket</div>
          <div class="value" id="kpi-extra">-</div>
        </div>
      </section>

      <section class="dash-grid" id="dash-grid">
        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Fretes por período</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Fretes por período"
                onclick="enterFullscreen('c1-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c1-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-fretes"></canvas>
          </div>
        </article>

        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Custos vs Receita</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Custos vs Receita"
                onclick="enterFullscreen('c2-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c2-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-custos-receita"></canvas>
          </div>
        </article>

        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Top motoristas</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Top motoristas"
                onclick="enterFullscreen('c4-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c4-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-top-motoristas"></canvas>
          </div>
        </article>

        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Top veículos</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Top veículos"
                onclick="enterFullscreen('c5-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c5-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-top-veiculos"></canvas>
          </div>
        </article>

        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Análise de despesas</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Análise de despesas"
                onclick="enterFullscreen('c6-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c6-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-despesas"></canvas>
          </div>
        </article>

        <article class="dash-card">
          <div class="dash-header">
            <span class="dash-title">Análise de rotas</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Tela cheia: Análise de rotas"
                onclick="enterFullscreen('c7-wrap')"
              >
                <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div class="chart-wrap" id="c7-wrap">
            <div class="skeleton">
              <div class="placeholder-glow w-100">
                <span class="placeholder col-12"></span>
              </div>
            </div>
            <canvas id="chart-rotas"></canvas>
          </div>
        </article>

        <article class="dash-card" style="grid-column: 1 / -1">
          <div class="dash-header">
            <span class="dash-title">Últimas viagens</span>
            <div class="d-print-none">
              <button
                class="btn btn-outline-secondary btn-sm"
                aria-label="Atualizar"
                onclick="buildUltimasViagens()"
              >
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
          <div class="table-wrap">
            <div class="placeholder-glow" id="uv-skeleton">
              <span class="placeholder col-12"></span>
              <span class="placeholder col-10 mt-2"></span>
              <span class="placeholder col-8 mt-2"></span>
            </div>
            <div class="table-responsive d-none" id="uv-table-wrap">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Placa</th>
                    <th>Origem → Destino</th>
                    <th>Valor</th>
                    <th>NF-e</th>
                  </tr>
                </thead>
                <tbody id="uv-tbody"></tbody>
              </table>
            </div>
          </div>
        </article>
      </section>
    </main>

    <script>
      (function initTheme() {
        const isDark = sessionStorage.getItem("darktheme") === "true";
        document.body.setAttribute("data-bs-theme", isDark ? "dark" : "light");
      })();

      function cssVar(name) {
        return getComputedStyle(document.body).getPropertyValue(name).trim();
      }
      function chartPalette() {
        const base = cssVar("--bs-body-color") || "#212529";
        const grid = cssVar("--bs-border-color") || "rgba(0,0,0,.1)";
        const secondary = cssVar("--bs-secondary-color") || "#6c757d";
        const primary =
          getComputedStyle(document.documentElement)
            .getPropertyValue("--bs-primary")
            .trim() || "#0d6efd";
        const success =
          getComputedStyle(document.documentElement)
            .getPropertyValue("--bs-success")
            .trim() || "#198754";
        const info =
          getComputedStyle(document.documentElement)
            .getPropertyValue("--bs-info")
            .trim() || "#0dcaf0";
        const warning =
          getComputedStyle(document.documentElement)
            .getPropertyValue("--bs-warning")
            .trim() || "#ffc107";
        const danger =
          getComputedStyle(document.documentElement)
            .getPropertyValue("--bs-danger")
            .trim() || "#dc3545";
        const purple = "#6f42c1";
        const teal = "#20c997";
        return {
          base,
          grid,
          secondary,
          primary,
          success,
          info,
          warning,
          danger,
          purple,
          teal,
        };
      }

      function enterFullscreen(wrapId) {
        const el = document.getElementById(wrapId);
        if (!el) return;
        (
          el.requestFullscreen ||
          el.webkitRequestFullscreen ||
          el.mozRequestFullScreen ||
          el.msRequestFullscreen
        )?.call(el);
      }

      const fmtBRL = (v) =>
        Number(v || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      const fmtMes = (s) => s;

      const ENDPOINTS = {
        kpis: "/dash/kpis",
        fretesPeriodo: "/dash/viagens-mensal",
        custosReceita: "/dash/resumo-financeiro",
        topMotoristas: "/dash/top-motoristas",
        topVeiculos: "/dash/top-veiculos",
        analiseDespesas: "/dash/analise-despesas",
        analiseRotas: "/dash/analise-rotas",
        ultimasViagens: "/dash/ultimas-viagens?limit=50",
      };

      async function getJSON(path) {
        try {
          const r = await window.__AUTH__.callApi(path);
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return [];
          }
          if (!r.ok) return [];
          return await r.json();
        } catch (e) {
          console.error("GET JSON fail", path, e);
          return [];
        }
      }

      async function buildKPIs() {
        const data = await getJSON(ENDPOINTS.kpis);
        const row = Array.isArray(data) ? data[0] || {} : data || {};
        const qtd = row.qtd_viagens ?? row.total_viagens ?? row.qtd ?? "-";
        const rec = row.receita_total ?? row.receita ?? null;
        const cus = row.custo_total ?? row.custos ?? null;
        const margem = row.margem_percent ?? row.margem ?? null;
        const ticket = row.ticket_medio ?? row.ticket ?? null;

        document.getElementById("kpi-viagens").textContent = String(qtd);
        document.getElementById("kpi-receita").textContent =
          rec != null ? fmtBRL(rec) : "-";
        document.getElementById("kpi-custos").textContent =
          cus != null ? fmtBRL(cus) : "-";

        let extra = "-";
        if (margem != null && !isNaN(Number(margem)))
          extra = `${Number(margem).toFixed(1)}%`;
        if (ticket != null && !isNaN(Number(ticket)))
          extra += ` • ${fmtBRL(ticket)}`;
        document.getElementById("kpi-extra").textContent = extra;
      }

      let CHARTS = {};

      async function buildFretesPeriodo() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.fretesPeriodo);
          const labels = data.map((d) => fmtMes(d.mes || d.data));
          const values = data.map((d) =>
            Number(d.total_fretes ?? d.total ?? 0)
          );
          const el = document.getElementById("chart-fretes")?.getContext("2d");
          if (!el) throw new Error("canvas chart-fretes não encontrado");

          CHARTS.fretes?.destroy();
          CHARTS.fretes = new Chart(el, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Fretes",
                  data: values,
                  borderColor: pal.primary,
                  backgroundColor: pal.primary + "33",
                  fill: true,
                  tension: 0.25,
                  pointRadius: 2,
                },
              ],
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: { label: (ctx) => ` ${ctx.parsed.y} fretes` },
                },
              },
              scales: {
                x: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
                y: {
                  ticks: { color: pal.secondary, precision: 0 },
                  grid: { color: pal.grid },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-fretes");
        }
      }

      async function buildCustosReceita() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.custosReceita);
          const labels = data.map((d) => fmtMes(d.mes || d.data));
          const custos = data.map((d) => Number(d.custos || 0));
          const receita = data.map((d) => Number(d.receita || 0));
          const el = document
            .getElementById("chart-custos-receita")
            ?.getContext("2d");
          if (!el)
            throw new Error("canvas chart-custos-receita não encontrado");

          CHARTS.cr?.destroy();
          CHARTS.cr = new Chart(el, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Custos",
                  data: custos,
                  backgroundColor: pal.warning + "88",
                  borderColor: pal.warning,
                  borderWidth: 1,
                },
                {
                  label: "Receita",
                  data: receita,
                  backgroundColor: pal.success + "88",
                  borderColor: pal.success,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { labels: { color: pal.base } },
                tooltip: {
                  callbacks: {
                    label: (ctx) =>
                      ` ${ctx.dataset.label}: ${fmtBRL(ctx.parsed.y)}`,
                  },
                },
              },
              scales: {
                x: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
                y: {
                  ticks: { color: pal.secondary, callback: (v) => fmtBRL(v) },
                  grid: { color: pal.grid },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-custos-receita");
        }
      }

      async function buildTopMotoristas() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.topMotoristas);
          const top = [...data]
            .sort(
              (a, b) => Number(b.valor_total || 0) - Number(a.valor_total || 0)
            )
            .slice(0, 10);
          const labels = top.map((d) => d.motorista || d.nome || "-");
          const valores = top.map((d) => Number(d.valor_total || 0));
          const el = document
            .getElementById("chart-top-motoristas")
            ?.getContext("2d");
          if (!el)
            throw new Error("canvas chart-top-motoristas não encontrado");

          CHARTS.tm?.destroy();
          CHARTS.tm = new Chart(el, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Valor",
                  data: valores,
                  backgroundColor: pal.info + "88",
                  borderColor: pal.info,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: { label: (ctx) => ` ${fmtBRL(ctx.parsed.x)}` },
                },
              },
              scales: {
                x: {
                  ticks: { color: pal.secondary, callback: (v) => fmtBRL(v) },
                  grid: { color: pal.grid },
                },
                y: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-top-motoristas");
        }
      }

      async function buildTopVeiculos() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.topVeiculos);
          const top = [...data]
            .sort(
              (a, b) => Number(b.valor_total || 0) - Number(a.valor_total || 0)
            )
            .slice(0, 10);
          const labels = top.map((d) => d.placa || d.veiculo || "-");
          const valores = top.map((d) => Number(d.valor_total || 0));
          const el = document
            .getElementById("chart-top-veiculos")
            ?.getContext("2d");
          if (!el) throw new Error("canvas chart-top-veiculos não encontrado");

          CHARTS.tv?.destroy();
          CHARTS.tv = new Chart(el, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Valor",
                  data: valores,
                  backgroundColor: pal.purple + "88",
                  borderColor: pal.purple,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: { label: (ctx) => ` ${fmtBRL(ctx.parsed.x)}` },
                },
              },
              scales: {
                x: {
                  ticks: { color: pal.secondary, callback: (v) => fmtBRL(v) },
                  grid: { color: pal.grid },
                },
                y: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-top-veiculos");
        }
      }

      async function buildAnaliseDespesas() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.analiseDespesas);
          const map = {};
          data.forEach((d) => {
            const k = d.categoria || d.tipo || "Outros";
            map[k] = (map[k] || 0) + Number(d.valor || 0);
          });
          const labels = Object.keys(map);
          const valores = Object.values(map);
          const colors = labels.map(
            (_, i) =>
              [
                pal.info,
                pal.warning,
                pal.success,
                pal.teal,
                pal.primary,
                pal.danger,
                pal.purple,
              ][i % 7] + "88"
          );

          const el = document
            .getElementById("chart-despesas")
            ?.getContext("2d");
          if (!el) throw new Error("canvas chart-despesas não encontrado");

          CHARTS.desp?.destroy();
          CHARTS.desp = new Chart(el, {
            type: "doughnut",
            data: {
              labels,
              datasets: [
                { data: valores, backgroundColor: colors, borderWidth: 1 },
              ],
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { labels: { color: pal.base } },
                tooltip: {
                  callbacks: {
                    label: (ctx) => ` ${ctx.label}: ${fmtBRL(ctx.parsed)}`,
                  },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-despesas");
        }
      }

      async function buildAnaliseRotas() {
        const pal = chartPalette();
        try {
          const data = await getJSON(ENDPOINTS.analiseRotas);
          const rows = [...data]
            .sort((a, b) => Number(b.qtd || 0) - Number(a.qtd || 0))
            .slice(0, 10);
          const labels = rows.map(
            (d) => `${d.origem || "-"} → ${d.destino || "-"}`
          );
          const qtd = rows.map((d) => Number(d.qtd || 0));
          const el = document.getElementById("chart-rotas")?.getContext("2d");
          if (!el) throw new Error("canvas chart-rotas não encontrado");

          CHARTS.rotas?.destroy();
          CHARTS.rotas = new Chart(el, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Viagens",
                  data: qtd,
                  backgroundColor: pal.teal + "88",
                  borderColor: pal.teal,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: "y",
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
                y: {
                  ticks: { color: pal.secondary },
                  grid: { color: pal.grid },
                },
              },
            },
          });
        } finally {
          hideSkeletonByCanvas("chart-rotas");
        }
      }

      function hideSkeletonByCanvas(canvasId) {
        const cv = document.getElementById(canvasId);
        const sk = cv?.closest(".chart-wrap")?.querySelector(".skeleton");
        if (sk) sk.style.display = "none";
      }

      async function buildUltimasViagens() {
        const sk = document.getElementById("uv-skeleton");
        const wrap = document.getElementById("uv-table-wrap");
        const tbody = document.getElementById("uv-tbody");
        sk.classList.remove("d-none");
        wrap.classList.add("d-none");
        tbody.innerHTML = "";

        const rows = await getJSON(ENDPOINTS.ultimasViagens);
        const fmtDate = (s) => {
          if (!s) return "-";
          const d = new Date(String(s).trim() + "T00:00:00");
          return isNaN(d) ? s : d.toLocaleDateString("pt-BR");
        };

        if (!rows || !rows.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-secondary">Sem dados.</td></tr>`;
        } else {
          rows.forEach((v) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${fmtDate(v.data_viagem)}</td>
              <td>${v.placa || "-"}</td>
              <td>${v.origem || "-"} &rarr; ${v.destino || "-"}</td>
              <td>${fmtBRL(v.valor || 0)}</td>
              <td>${v.nf || "-"}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        sk.classList.add("d-none");
        wrap.classList.remove("d-none");
      }

      const obs = new MutationObserver(() => buildAll());
      obs.observe(document.body, {
        attributes: true,
        attributeFilter: ["data-bs-theme"],
      });

      async function buildAll() {
        await Promise.all([
          buildKPIs(),
          buildFretesPeriodo(),
          buildCustosReceita(),
          buildTopMotoristas(),
          buildTopVeiculos(),
          buildAnaliseDespesas(),
          buildAnaliseRotas(),
        ]);
        await buildUltimasViagens();
      }

      document.addEventListener("DOMContentLoaded", buildAll);
    </script>

    <script src="../public/header.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
