<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Gestão de viagens • Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../dark.css" />

    <script>
      window.APP_PATH = "/frete-avulso-front";
      window.API_URL =
        location.hostname === "localhost" || location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : "https://frete-avulso-back.onrender.com";

      function goTo(path) {
        location.href = location.origin + window.APP_PATH + path;
      }
    </script>

    <style>
      :root {
        --glass-bg: color-mix(in srgb, var(--bs-body-bg), transparent 28%);
        --glass-brd: color-mix(
          in srgb,
          var(--bs-border-color),
          transparent 30%
        );
        --shadow-1: 0 10px 26px rgba(0, 0, 0, 0.1);
      }
      [data-bs-theme="dark"] {
        --glass-bg: rgba(28, 31, 35, 0.88);
        --glass-brd: rgba(255, 255, 255, 0.08);
        --shadow-1: 0 14px 38px rgba(0, 0, 0, 0.55);
      }

      html,
      body {
        height: 100%;
      }
      body {
        min-height: 100svh;
        background: radial-gradient(
            800px 500px at -10% -10%,
            color-mix(in srgb, var(--bs-primary), transparent 92%),
            transparent 60%
          ),
          radial-gradient(
            900px 600px at 110% 10%,
            color-mix(in srgb, var(--bs-info), transparent 92%),
            transparent 65%
          ),
          var(--bs-body-bg);
      }

      :focus {
        outline: 2px solid
          color-mix(in srgb, var(--bs-primary), transparent 55%);
        outline-offset: 2px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .wrap {
        min-height: 100svh;
        display: grid;
        place-items: center;
        position: relative;
        overflow: hidden;
        padding: clamp(12px, 3vw, 24px);
      }

      .auth-card {
        width: min(520px, 94vw);
        border-radius: 18px;
        border: 1px solid var(--glass-brd);
        background: var(--glass-bg);
        backdrop-filter: saturate(140%) blur(10px);
        -webkit-backdrop-filter: saturate(140%) blur(10px);
        box-shadow: var(--shadow-1);
        padding: clamp(18px, 3.5vw, 28px);
        position: relative;
        z-index: 1;
      }

      .brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        margin-bottom: 0.25rem;
      }
      .brand-icon {
        display: inline-grid;
        place-items: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: color-mix(in srgb, var(--bs-primary), transparent 86%);
        border: 1px solid var(--bs-border-color);
      }
      .brand-icon i {
        font-size: 1.05rem;
        opacity: 0.9;
      }
      .brand h1 {
        margin: 0;
        font-size: clamp(1.1rem, 2.4vw, 1.3rem);
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .subtitle {
        text-align: center;
        color: var(--bs-secondary-color);
        margin: 0.25rem 0 1rem;
      }

      .form-floating > .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: none;
      }

      #btnLogin .spinner-border {
        display: none;
      }
      #btnLogin[data-loading="true"] .spinner-border {
        display: inline-block;
      }
      #btnLogin[data-loading="true"] .text {
        display: none;
      }

      .theme-fab {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 2;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 999px;
        padding: 0.28rem 0.6rem;
        box-shadow: var(--shadow-1);
      }
      .theme-fab i {
        font-size: 0.95rem;
        opacity: 0.85;
      }
      .theme-fab .form-check-input {
        cursor: pointer;
      }

      .decor {
        position: absolute;
        inset: auto -60px -60px auto;
        z-index: 0;
        pointer-events: none;
        user-select: none;
        display: none;
        filter: blur(1px) saturate(110%);
        opacity: 1;
        transform: rotate(-4deg);
      }
      .decor img {
        display: block;
        width: min(34vw, 500px);
        max-width: 500px;
        height: auto;
        object-fit: contain;
      }
      @media (min-width: 768px) {
        .decor {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <a class="sr-only visually-hidden-focusable" href="#main"
      >Pular para o conteúdo</a
    >
    <div class="theme-fab">
      <i class="bi bi-sun-fill" aria-hidden="true"></i>
      <div class="form-check form-switch m-0">
        <input
          class="form-check-input"
          type="checkbox"
          role="switch"
          id="switch-theme"
          aria-label="Alternar modo escuro"
        />
      </div>
      <i class="bi bi-moon-stars-fill" aria-hidden="true"></i>
    </div>

    <main
      id="main"
      class="wrap"
      role="main"
      tabindex="-1"
      aria-labelledby="page-title"
    >
      <section class="auth-card">
        <div class="brand">
          <span class="brand-icon" aria-hidden="true"
            ><i class="bi bi-signpost-2"></i
          ></span>
          <h1 id="page-title">Gestão de viagens</h1>
        </div>
        <p class="subtitle">Acesse para continuar</p>

        <form id="loginForm" novalidate aria-describedby="mensagem-erro">
          <div class="form-floating mb-2">
            <input
              type="text"
              class="form-control"
              id="cpf"
              name="cpf"
              placeholder="usuário/CPF"
              autocomplete="username"
              aria-describedby="cpf-err"
            />
            <label for="cpf">CPF / Usuário</label>
            <span id="cpf-err" class="sr-only" aria-live="polite"></span>
          </div>

          <div class="form-floating mb-3">
            <input
              type="password"
              class="form-control"
              id="senha"
              name="senha"
              placeholder="Senha"
              autocomplete="current-password"
              aria-describedby="senha-err"
              onkeydown="if(event.key==='Enter'){ event.preventDefault(); doLogin(); }"
            />
            <label for="senha">Senha</label>
            <span id="senha-err" class="sr-only" aria-live="polite"></span>
          </div>

          <button
            id="btnLogin"
            class="btn btn-primary w-100 py-2"
            type="button"
            aria-label="Entrar"
            onclick="doLogin()"
          >
            <span
              class="spinner-border spinner-border-sm"
              aria-hidden="true"
            ></span>
            <span class="sr-only">Aguarde. Fazendo o login.</span>
            <span class="text">Entrar</span>
          </button>

          <div id="mensagem-erro" class="mt-3" aria-live="assertive"></div>
        </form>
      </section>

      <div class="decor" aria-hidden="true">
        <img src="./imagens/truck.png" alt="Imagem de um caminhão" />
      </div>
    </main>

    <script>
      function setThemeFromStorage() {
        const isDark = sessionStorage.getItem("darktheme") === "true";
        document.body.setAttribute("data-bs-theme", isDark ? "dark" : "light");
        const sw = document.getElementById("switch-theme");
        if (sw) sw.checked = isDark;
      }
      setThemeFromStorage();
      document
        .getElementById("switch-theme")
        .addEventListener("change", (e) => {
          sessionStorage.setItem("darktheme", e.target.checked);
          setThemeFromStorage();
        });

      const $ = (s) => document.querySelector(s);

      function showAlert(ancora, tipo, mensagem) {
        const w = document.createElement("div");
        w.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center" role="alert" tabindex="-1">
          <div>${mensagem}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>`;
        ancora.innerHTML = "";
        const el = w.firstChild;
        ancora.append(el);
        el.focus();
      }

      function setLoading(state) {
        const btn = $("#btnLogin");
        btn.dataset.loading = state ? "true" : "false";
        btn.setAttribute("aria-disabled", state ? "true" : "false");
      }

      function setFieldError(inputId, errId, msg) {
        const input = document.getElementById(inputId);
        const err = document.getElementById(errId);
        if (msg) {
          input.setAttribute("aria-invalid", "true");
          err.textContent = msg;
        } else {
          input.removeAttribute("aria-invalid");
          err.textContent = "";
        }
      }

      function validateClient() {
        const cpf = $("#cpf").value.trim();
        const senha = $("#senha").value;
        let first = null;

        if (!cpf) {
          setFieldError("cpf", "cpf-err", "Informe o CPF/usuário.");
          first = first || "cpf";
        } else setFieldError("cpf", "cpf-err", "");

        if (!senha) {
          setFieldError("senha", "senha-err", "Informe a senha.");
          first = first || "senha";
        } else setFieldError("senha", "senha-err", "");

        if (first) {
          document.getElementById(first).focus();
          return false;
        }
        return true;
      }

      async function chamadaParaAPI(cpf, senha) {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 12000);
        try {
          const resp = await fetch(window.API_URL + "/login", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ cpf, senha }),
            signal: controller.signal,
          });
          let data = {};
          try {
            data = await resp.json();
          } catch {}
          return { status: resp.status, data };
        } finally {
          clearTimeout(t);
        }
      }

      async function doLogin() {
        if (!validateClient()) return;

        const cpf = $("#cpf").value.trim();
        const senha = $("#senha").value;

        setLoading(true);
        try {
          const login = await chamadaParaAPI(cpf, senha);
          if (login.status === 200 && login.data?.access_token) {
            sessionStorage.setItem("token", login.data.access_token);
            sessionStorage.setItem("user", cpf);
            goTo("/viagens");
          } else {
            const msg = login.data?.message || "Credenciais inválidas.";
            setFieldError("cpf", "cpf-err", "Credenciais inválidas.");
            setFieldError("senha", "senha-err", "Credenciais inválidas.");
            showAlert($("#mensagem-erro"), "warning", msg);
            $("#cpf").focus();
          }
        } catch {
          showAlert(
            $("#mensagem-erro"),
            "danger",
            "Falha ao conectar ao servidor. Verifique o backend (URL e CORS)."
          );
        } finally {
          setLoading(false);
        }
      }

      document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        doLogin();
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
