<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Veículo • Gestão de viagens</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script>
      window.APP_PATH = "/frete-avulso-front";
      window.API_URL =
        location.hostname === "localhost" || location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : "https://frete-avulso-back.onrender.com";
    </script>
    <script src="../auth.js"></script>
    <script>
      (async () => {
        await window.__AUTH__.requireAuth();
      })();
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../dark.css" />
    <link rel="stylesheet" href="../public/header.css" />

    <style>
      :root {
        --card-radius: 16px;
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.08);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.14);
      }
      [data-bs-theme="dark"] {
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.45);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.6);
      }
      main {
        margin-top: var(--app-header-h, 64px);
      }

      .page-wrap {
        padding-block: clamp(16px, 2.5vw, 28px);
        max-width: 1024px;
      }
      .page-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .page-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .hint {
        color: var(--bs-secondary-color);
      }

      .sheet {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
      }
      .sheet:hover {
        box-shadow: var(--shadow-2);
      }
      .sheet-header {
        padding: 1rem 1.25rem 0.75rem;
        border-bottom: 1px dashed var(--bs-border-color);
      }
      .sheet-body {
        padding: 1rem 1.25rem 1.25rem;
      }

      .form-grid {
        display: grid;
        gap: 0.9rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 768px) {
        .form-grid {
          grid-template-columns: repeat(12, 1fr);
          align-items: end;
        }
        .col-span-2 {
          grid-column: span 2;
        }
        .col-span-3 {
          grid-column: span 3;
        }
        .col-span-4 {
          grid-column: span 4;
        }
        .col-span-12 {
          grid-column: span 12;
        }
      }

      .form-control:focus,
      .form-select:focus {
        border-color: rgba(var(--bs-primary-rgb), 0.45);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
      }

      .data-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
      }
      .table > thead th {
        border-bottom: 1px solid var(--bs-border-color);
      }
      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: var(--bs-tertiary-bg) !important;
      }
      .table-hover tbody tr:hover > * {
        background-color: rgba(var(--bs-primary-rgb), 0.08) !important;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--bs-border-color);
        border-bottom-left-radius: var(--card-radius);
        border-bottom-right-radius: var(--card-radius);
        background: var(--bs-body-bg);
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid var(--bs-border-color);
      }
      .btn-ghost:hover {
        border-color: rgba(var(--bs-primary-rgb), 0.45);
        background: var(--bs-tertiary-bg);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: #00000033;
        z-index: 1055;
      }
      :focus {
        outline: 2px solid
          color-mix(in srgb, var(--bs-primary), transparent 55%);
        outline-offset: 2px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>

  <body>
    <a class="visually-hidden-focusable" href="#main">Pular para o conteúdo</a>

    <main
      id="main"
      class="container page-wrap"
      role="main"
      tabindex="-1"
      aria-labelledby="page-title"
    >
      <div id="mensagem-erro" class="mb-3" aria-live="assertive"></div>

      <div class="page-head">
        <div class="page-title h4 m-0">
          <i class="bi bi-truck"></i>
          <span id="page-title">Cadastro de veículos</span>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-ghost" href="../viagens"
            ><i class="bi bi-arrow-left-short"></i> Viagens</a
          >
        </div>
      </div>
      <div class="hint mb-3">
        Preencha os campos e salve. Edite itens na lista abaixo.
      </div>

      <section class="sheet mb-4" aria-labelledby="form-title">
        <div class="sheet-header">
          <h2 class="h6 m-0" id="form-title">Dados do veículo</h2>
        </div>
        <div class="sheet-body">
          <form novalidate>
            <input type="hidden" name="method" id="method" value="post" />
            <div class="form-grid">
              <div class="col-span-2">
                <label for="placa" class="form-label">Placa</label>
                <input
                  name="placa"
                  id="placa"
                  type="text"
                  class="form-control text-uppercase"
                  placeholder="ABC-1234"
                  autocomplete="off"
                  inputmode="text"
                  pattern="^[A-Z]{3}-\d{4}$"
                  maxlength="8"
                  aria-describedby="placa-help placa-err"
                />
                <div id="placa-help" class="form-text">
                  Use o padrão ABC-1234.
                </div>
                <span id="placa-err" class="sr-only" aria-live="polite"></span>
              </div>

              <div class="col-span-4">
                <label for="descricao" class="form-label">Descrição</label>
                <input
                  name="descricao"
                  id="descricao"
                  type="text"
                  class="form-control"
                  placeholder="Caminhão caçamba preto"
                  autocomplete="off"
                  aria-describedby="desc-err"
                />
                <span id="desc-err" class="sr-only" aria-live="polite"></span>
              </div>

              <div class="col-span-4">
                <label for="cpf_motorista" class="form-label">Motorista</label>
                <select
                  class="form-select"
                  name="cpf_motorista"
                  id="cpf_motorista"
                  aria-label="Selecionar motorista"
                ></select>
              </div>

              <div class="col-span-12 d-flex gap-2 justify-content-end">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="resetarFormulario()"
                  aria-label="Limpar formulário"
                >
                  Limpar
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                  aria-label="Salvar veículo"
                >
                  Salvar
                </button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <section class="data-card">
        <div class="sheet-header">
          <h2 class="h6 m-0">Veículos cadastrados</h2>
        </div>
        <div class="sheet-body">
          <div class="table-responsive">
            <table
              id="table-veiculos"
              class="table table-striped table-hover align-middle mb-0"
            >
              <caption class="text-start">
                Lista de veículos
              </caption>
              <thead>
                <tr>
                  <th scope="col">Placa</th>
                  <th scope="col">Descrição</th>
                  <th scope="col">Motorista</th>
                  <th scope="col" class="text-end" style="width: 120px">
                    Ações
                  </th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <div
      class="overlay d-flex align-items-center justify-content-center d-none"
      aria-hidden="true"
    >
      <div class="loading d-flex justify-content-center">
        <div
          class="spinner-border text-primary spinner-border-sm"
          role="status"
          aria-label="Carregando"
          style="width: 3rem; height: 3rem"
        ></div>
      </div>
    </div>

    <script>
      (function initTheme() {
        const isDark = sessionStorage.getItem("darktheme") === "true";
        document.body.setAttribute("data-bs-theme", isDark ? "dark" : "light");
      })();

      const slotAvisos = document.querySelector("#mensagem-erro");

      function exibirAlerta(ancora, tipo, mensagem) {
        const w = document.createElement("div");
        w.innerHTML = [
          `<div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center" role="alert" aria-live="assertive" aria-atomic="true" tabindex="-1">`,
          `  <div>${mensagem}</div>`,
          `  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`,
          `</div>`,
        ].join("");
        const el = w.firstChild;
        ancora.innerHTML = "";
        ancora.append(el);
        el.focus();
      }
      const exibirMensagemDeErro = (a, m) => exibirAlerta(a, "danger", m);
      const exibirMensagemDeAviso = (a, m) => exibirAlerta(a, "warning", m);
      const exibirMensagemDeSucesso = (a, m) => exibirAlerta(a, "success", m);

      function loadingStart() {
        const o = document.querySelector("div.overlay");
        o.classList.remove("d-none");
        o.classList.add("d-flex");
        o.setAttribute("aria-busy", "true");
        o.removeAttribute("aria-hidden");
      }
      function loadingStop() {
        const o = document.querySelector("div.overlay");
        o.classList.add("d-none");
        o.classList.remove("d-flex");
        o.removeAttribute("aria-busy");
        o.setAttribute("aria-hidden", "true");
      }

      function setFieldError(id, errId, msg) {
        const input = document.getElementById(id),
          err = document.getElementById(errId);
        if (msg) {
          input.setAttribute("aria-invalid", "true");
          err.textContent = msg;
        } else {
          input.removeAttribute("aria-invalid");
          err.textContent = "";
        }
      }

      async function atualizaListaVeiculos() {
        try {
          loadingStart();
          const response = await window.__AUTH__.callApi("/veiculo");
          if (response.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!response.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível localizar os veículos cadastrados"
            );
            return;
          }

          window.veiculos = await response.json();
          const tbody = document.querySelector("#table-veiculos tbody");
          let itens = "";
          for (const veiculo of veiculos) {
            veiculo.cpf_motorista = veiculo.cpf_motorista ?? "";
            const m = (window.motoristas || []).find(
              (x) => x.cpf == veiculo.cpf_motorista
            );
            const nome = m ? m.nome : "-";
            itens += `<tr>
              <td>${veiculo.placa}</td>
              <td>${veiculo.descricao}</td>
              <td>${nome}</td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-primary" onClick="editarVeiculo('${veiculo.placa}')" aria-label="Editar veículo ${veiculo.placa}">
                  <i class="bi bi-pencil-square"></i> Editar
                </button>
              </td>
            </tr>`;
          }
          tbody.innerHTML =
            itens ||
            `<tr><td colspan="4" class="text-center text-secondary py-3">Sem veículos</td></tr>`;
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível localizar os veículos cadastrados"
          );
        } finally {
          loadingStop();
        }
      }

      async function buscarMotoristas() {
        try {
          const response = await window.__AUTH__.callApi("/motorista");
          if (response.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!response.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível localizar os motoristas cadastrados"
            );
            return;
          }

          window.motoristas = await response.json();
          const select = document.getElementById("cpf_motorista");
          select.innerHTML = "";
          const opt = document.createElement("option");
          opt.text = "-";
          opt.value = "";
          select.appendChild(opt);
          for (const motorista of motoristas) {
            const o = document.createElement("option");
            o.text = motorista.nome;
            o.value = motorista.cpf;
            select.appendChild(o);
          }
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível localizar os motoristas cadastrados"
          );
        }
      }

      function resetarFormulario() {
        document.getElementById("method").value = "post";
        document.getElementById("descricao").value = "";
        document.getElementById("cpf_motorista").value = "";
        document.getElementById("placa").value = "";
        document.getElementById("placa").removeAttribute("disabled");
        setFieldError("placa", "placa-err", "");
        setFieldError("descricao", "desc-err", "");
      }

      function editarVeiculo(placa) {
        const v = (window.veiculos || []).find((x) => x.placa == placa);
        document.getElementById("method").value = "put";
        document.getElementById("descricao").value = v.descricao;
        document.getElementById("cpf_motorista").value = v.cpf_motorista || "";
        document.getElementById("placa").value = placa;
        document.getElementById("placa").setAttribute("disabled", "");
      }

      function validateClient() {
        const placa = document
          .getElementById("placa")
          .value.trim()
          .toUpperCase();
        const descricao = document.getElementById("descricao").value.trim();
        let first = null;

        if (!/^[A-Z]{3}-\d{4}$/.test(placa)) {
          setFieldError("placa", "placa-err", "Placa no formato ABC-1234.");
          first = first || "placa";
        } else setFieldError("placa", "placa-err", "");

        if (descricao.length < 2) {
          setFieldError("descricao", "desc-err", "Informe a descrição.");
          first = first || "descricao";
        } else setFieldError("descricao", "desc-err", "");

        if (first) {
          document.getElementById(first).focus();
          return false;
        }
        return true;
      }

      document.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateClient()) return;

        loadingStart();
        const method = document.getElementById("method").value;
        const descricao = document.getElementById("descricao").value.trim();
        const placa = document.getElementById("placa").value.toUpperCase();
        const cpf_motorista = document
          .getElementById("cpf_motorista")
          .value.toUpperCase();
        const path = method === "put" ? `/veiculo/${placa}` : "/veiculo";

        try {
          const r = await window.__AUTH__.callApi(path, {
            method,
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ placa, descricao, cpf_motorista }),
          });
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (r.status == 400) {
            let { message } = await r.json().catch(() => ({}));
            exibirMensagemDeAviso(slotAvisos, message || "Dados inválidos.");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível salvar os dados desse veículo"
            );
            return;
          }

          exibirMensagemDeSucesso(slotAvisos, "Veículo salvo");
          resetarFormulario();
          await atualizaListaVeiculos();
        } catch {
          exibirMensagemDeErro(
            slotAvisos,
            "Erro ao salvar os dados. Tente novamente."
          );
        } finally {
          loadingStop();
        }
      });

      (async function onLoad() {
        loadingStart();
        await buscarMotoristas();
        await atualizaListaVeiculos();
        loadingStop();
      })();
    </script>

    <script src="../public/header.js" defer></script>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
