<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Viagem • Gestão de viagens</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script>
      window.APP_PATH = "/frete-avulso-front";
      window.API_URL =
        location.hostname === "localhost" || location.hostname === "127.0.0.1"
          ? "http://127.0.0.1:5000"
          : "https://frete-avulso-back.onrender.com";
    </script>
    <script src="../auth.js"></script>
    <script>
      (async () => {
        await window.__AUTH__.requireAuth();
      })();
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../dark.css" />
    <link rel="stylesheet" href="../public/header.css" />

    <style>
      :root {
        --card-radius: 16px;
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.08);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.14);
      }
      [data-bs-theme="dark"] {
        --shadow-1: 0 8px 24px rgba(0, 0, 0, 0.45);
        --shadow-2: 0 16px 40px rgba(0, 0, 0, 0.6);
      }

      main {
        margin-top: var(--app-header-h, 64px);
      }

      .page-wrap {
        padding-block: clamp(16px, 2.5vw, 28px);
        max-width: 1024px;
      }
      .page-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .page-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .tag-soft {
        border: 1px solid var(--bs-border-color);
        background: var(--bs-tertiary-bg);
        color: var(--bs-emphasis-color);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
      }
      .hint {
        color: var(--bs-secondary-color);
      }

      .sheet {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
      }
      .sheet:hover {
        box-shadow: var(--shadow-2);
      }
      .sheet-header {
        padding: 1rem 1.25rem 0.75rem;
        border-bottom: 1px dashed var(--bs-border-color);
      }
      .sheet-body {
        padding: 1rem 1.25rem 1.25rem;
      }

      .form-grid {
        display: grid;
        gap: 0.9rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 768px) {
        .form-grid {
          grid-template-columns: repeat(12, 1fr);
          align-items: end;
        }
        .col-span-4 {
          grid-column: span 4;
        }
        .col-span-3 {
          grid-column: span 3;
        }
        .col-span-2 {
          grid-column: span 2;
        }
        .col-span-6 {
          grid-column: span 6;
        }
        .col-span-12 {
          grid-column: span 12;
        }
      }

      .form-control:focus,
      .form-select:focus,
      textarea.form-control:focus {
        border-color: rgba(var(--bs-primary-rgb), 0.45);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
      }
      textarea.form-control {
        min-height: 110px;
      }

      .data-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-1);
      }
      .table > thead th {
        border-bottom: 1px solid var(--bs-border-color);
      }
      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: var(--bs-tertiary-bg) !important;
      }
      .table-hover tbody tr:hover > * {
        background-color: rgba(var(--bs-primary-rgb), 0.08) !important;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--bs-border-color);
        border-bottom-left-radius: var(--card-radius);
        border-bottom-right-radius: var(--card-radius);
        background: var(--bs-body-bg);
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid var(--bs-border-color);
      }
      .btn-ghost:hover {
        border-color: rgba(var(--bs-primary-rgb), 0.45);
        background: var(--bs-tertiary-bg);
      }

      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 1rem;
        max-width: 95%;
        width: 680px;
        z-index: 1056;
        box-shadow: var(--shadow-2);
      }
      .popup .close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: #00000033;
        z-index: 1055;
      }

      :focus {
        outline: 2px solid
          color-mix(in srgb, var(--bs-primary), transparent 55%);
        outline-offset: 2px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>

  <body>
    <a class="visually-hidden-focusable" href="#main">Pular para o conteúdo</a>

    <main
      id="main"
      class="container page-wrap"
      role="main"
      tabindex="-1"
      aria-labelledby="page-title"
    >
      <div id="mensagem-erro" class="mb-3" aria-live="assertive"></div>

      <div class="page-head">
        <div class="page-title h4 m-0">
          <i class="bi bi-pin-map"></i>
          <span id="page-title">Cadastro de viagem</span>
          <span class="tag-soft">Formulário & despesas</span>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-ghost" href="../viagens"
            ><i class="bi bi-arrow-left-short"></i> Voltar</a
          >
        </div>
      </div>
      <div class="hint mb-3">
        Preencha os dados, salve e (opcionalmente) adicione despesas.
      </div>

      <section class="sheet mb-4" aria-labelledby="form-title">
        <div class="sheet-header">
          <h2 class="h6 m-0" id="form-title">Dados da viagem</h2>
        </div>
        <div class="sheet-body">
          <form novalidate>
            <input type="hidden" name="method" id="method" value="post" />
            <input type="hidden" name="id" id="id" />

            <div class="form-grid">
              <div class="col-span-4">
                <label for="solicitante" class="form-label">Solicitante</label>
                <input
                  name="solicitante"
                  id="solicitante"
                  type="text"
                  class="form-control"
                  placeholder="Empresa solicitante"
                  autocomplete="organization"
                />
              </div>

              <div class="col-span-4">
                <label for="origem" class="form-label">Origem</label>
                <input
                  name="origem"
                  id="origem"
                  type="text"
                  class="form-control"
                  placeholder="Origem do trajeto"
                  autocomplete="off"
                />
              </div>

              <div class="col-span-4">
                <label for="destino" class="form-label">Destino</label>
                <input
                  name="destino"
                  id="destino"
                  type="text"
                  class="form-control"
                  placeholder="Destino do trajeto"
                  autocomplete="off"
                />
              </div>

              <div class="col-span-3">
                <label for="motorista" class="form-label">Motorista</label>
                <select
                  class="form-select"
                  name="motorista"
                  id="motorista"
                  aria-label="Selecionar motorista"
                  onchange="preencheVeiculo()"
                ></select>
              </div>

              <div class="col-span-3">
                <label for="placa" class="form-label">Veículo</label>
                <select
                  class="form-select"
                  name="placa"
                  id="placa"
                  aria-label="Selecionar veículo"
                ></select>
              </div>

              <div class="col-span-2">
                <label for="data" class="form-label">Data</label>
                <input name="data" id="data" type="date" class="form-control" />
              </div>

              <div class="col-span-2">
                <label for="valor" class="form-label">Valor</label>
                <div class="input-group">
                  <span class="input-group-text" aria-hidden="true">R$</span>
                  <input
                    name="valor"
                    id="valor"
                    type="number"
                    step="any"
                    class="form-control"
                    placeholder="0,00"
                    inputmode="decimal"
                  />
                </div>
              </div>

              <div class="col-span-2">
                <label for="nf" class="form-label">Nota fiscal</label>
                <input
                  name="nf"
                  id="nf"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                />
              </div>

              <div class="col-span-12">
                <label for="carga" class="form-label">Carga</label>
                <textarea
                  name="carga"
                  id="carga"
                  class="form-control"
                  placeholder="Descrição da carga transportada"
                ></textarea>
              </div>
            </div>
          </form>
        </div>
      </section>

      <section class="data-card">
        <div
          class="sheet-header d-flex align-items-center justify-content-between"
        >
          <h2 class="h6 m-0">Despesas</h2>
          <button
            id="btn-despesa"
            class="btn btn-outline-success btn-sm"
            disabled
            type="button"
            onclick="abrirDespesa()"
            aria-label="Adicionar despesa"
          >
            <i class="bi bi-plus-lg"></i> Despesa
          </button>
        </div>
        <div class="sheet-body">
          <div class="table-responsive">
            <table
              id="table-despesas"
              class="table table-striped table-hover align-middle mb-0"
            >
              <caption class="text-start">
                Lista de despesas da viagem
              </caption>
              <thead>
                <tr>
                  <th scope="col">Descrição</th>
                  <th scope="col" style="width: 160px">Valor</th>
                  <th scope="col" class="text-end" style="width: 120px">
                    Ações
                  </th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="actions">
            <button
              class="btn btn-outline-danger"
              id="btn-excluir"
              type="button"
              disabled
              aria-label="Excluir viagem"
            >
              Excluir
            </button>
            <button
              class="btn btn-primary"
              type="button"
              onclick="salvarViagem()"
              aria-label="Salvar viagem"
            >
              Salvar
            </button>
          </div>
        </div>
      </section>
    </main>

    <div
      id="popup"
      class="popup"
      role="dialog"
      aria-modal="true"
      aria-labelledby="popup-title"
      aria-hidden="true"
      tabindex="-1"
    ></div>

    <div
      class="overlay d-flex align-items-center justify-content-center d-none"
      aria-hidden="true"
    >
      <div class="loading d-flex justify-content-center">
        <div
          class="spinner-border text-primary spinner-border-sm"
          role="status"
          aria-label="Carregando"
          style="width: 3rem; height: 3rem"
        ></div>
      </div>
    </div>

    <script>
      (function init() {
        const isDark = sessionStorage.getItem("darktheme") === "true";
        document.body.setAttribute("data-bs-theme", isDark ? "dark" : "light");
      })();

      window.veiculos = [];
      const slotAvisos = document.querySelector("#mensagem-erro");

      function exibirAlerta(ancora, tipo, mensagem) {
        const w = document.createElement("div");
        w.innerHTML = [
          `<div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center" role="alert" aria-live="assertive" aria-atomic="true" tabindex="-1">`,
          `  <div>${mensagem}</div>`,
          `  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`,
          `</div>`,
        ].join("");
        const el = w.firstChild;
        ancora.innerHTML = "";
        ancora.append(el);
        el.focus();
      }
      const exibirMensagemDeErro = (a, m) => exibirAlerta(a, "danger", m);
      const exibirMensagemDeAviso = (a, m) => exibirAlerta(a, "warning", m);
      const exibirMensagemDeSucesso = (a, m) => exibirAlerta(a, "success", m);

      function loadingStart() {
        const o = document.querySelector("div.overlay");
        o.classList.remove("d-none");
        o.classList.add("d-flex");
        o.setAttribute("aria-busy", "true");
        o.removeAttribute("aria-hidden");
      }
      function loadingStop() {
        const o = document.querySelector("div.overlay");
        o.classList.add("d-none");
        o.classList.remove("d-flex");
        o.removeAttribute("aria-busy");
        o.setAttribute("aria-hidden", "true");
      }

      function preencheVeiculo() {
        const cpf = document.getElementById("motorista").value;
        const v = veiculos.find((x) => x.cpf_motorista === cpf);
        if (v) document.getElementById("placa").value = v.placa;
      }

      async function buscarMotoristas() {
        try {
          const r = await window.__AUTH__.callApi("/motorista");
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível localizar os motoristas cadastrados"
            );
            return;
          }
          window.motoristas = await r.json();
          const select = document.getElementById("motorista");
          select.innerHTML = "";
          for (const m of motoristas) {
            const o = document.createElement("option");
            o.text = m.nome;
            o.value = m.cpf;
            select.appendChild(o);
          }
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível localizar os motoristas cadastrados"
          );
        }
      }

      async function buscarVeiculos() {
        try {
          const r = await window.__AUTH__.callApi("/veiculo");
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível localizar os veículos cadastrados"
            );
            return;
          }
          window.veiculos = await r.json();
          const select = document.getElementById("placa");
          select.innerHTML = "";
          for (const v of veiculos) {
            const o = document.createElement("option");
            o.text = `${v.placa} - ${v.descricao}`;
            o.value = v.placa;
            select.appendChild(o);
          }
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível localizar os veículos cadastrados"
          );
        }
      }

      function habilitaExcluir(id) {
        const b = document.getElementById("btn-excluir");
        b.setAttribute("onclick", `excluirViagem(${id})`);
        b.setAttribute("aria-label", `Excluir viagem ${id}`);
        b.classList.remove("btn-outline-danger");
        b.classList.add("btn-danger");
        b.removeAttribute("disabled");
      }
      function habilitaBtnDespesa() {
        const b = document.getElementById("btn-despesa");
        b.classList.remove("btn-outline-success");
        b.classList.add("btn-success");
        b.removeAttribute("disabled");
      }
      function desabilitaExcluir() {
        const b = document.getElementById("btn-excluir");
        b.removeAttribute("onclick");
        b.removeAttribute("aria-label");
        b.classList.add("btn-outline-danger");
        b.classList.remove("btn-danger");
        b.setAttribute("disabled", "");
      }
      function desabilitaBtnDespesa() {
        const b = document.getElementById("btn-despesa");
        b.classList.add("btn-outline-success");
        b.classList.remove("btn-success");
        b.setAttribute("disabled", "");
      }
      function resetarFormulario() {
        document.getElementById("method").value = "post";
        document.getElementById("id").value = "";
        document.getElementById("solicitante").value = "";
        document.getElementById("origem").value = "";
        document.getElementById("destino").value = "";
        document.getElementById("motorista").value = "";
        document.getElementById("placa").value = "";
        document.getElementById("data").value = "";
        document.getElementById("valor").value = "";
        document.getElementById("nf").value = "";
        document.getElementById("carga").value = "";
        desabilitaExcluir();
        desabilitaBtnDespesa();
      }

      async function editarViagem(id) {
        try {
          loadingStart();
          const r = await window.__AUTH__.callApi(`/viagem/${id}`);
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível consultar os dados dessa viagem"
            );
            return;
          }
          window.viagemAEditar = await r.json();

          document.getElementById("method").value = "put";
          document.getElementById("id").value = viagemAEditar.id;
          document.getElementById("solicitante").value =
            viagemAEditar.solicitante ?? "";
          document.getElementById("origem").value = viagemAEditar.origem;
          document.getElementById("destino").value = viagemAEditar.destino;
          document.getElementById("motorista").value =
            viagemAEditar.cpf_motorista;
          document.getElementById("placa").value = viagemAEditar.placa;
          document.getElementById("data").value = viagemAEditar.data_viagem;
          document.getElementById("valor").value = viagemAEditar.valor;
          document.getElementById("nf").value = viagemAEditar.nf;
          document.getElementById("carga").value = viagemAEditar.carga;

          await preencheTabelaDespesas(id);
          habilitaExcluir(id);
          habilitaBtnDespesa();
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível trazer os dados dessa viagem"
          );
        } finally {
          loadingStop();
        }
      }

      async function preencheTabelaDespesas(id) {
        const table = document.getElementById("table-despesas");
        const r = await window.__AUTH__.callApi(`/viagem/${id}/despesas`);
        if (r.status == 401) {
          alert("login expirado");
          window.__AUTH__.goTo("/login");
          return;
        }
        if (!r.ok) {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível consultar as despesas dessa viagem"
          );
          return;
        }

        window.viagemAEditar.despesas = await r.json();
        let itens = "";
        for (const d of viagemAEditar.despesas) {
          const v = Number(d.valor) || 0;
          const vf = v.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          });
          itens += `<tr>
            <td data-title="Descrição">${d.descricao}</td>
            <td data-title="Valor"><span class="badge text-bg-light">${vf}</span></td>
            <td data-title="Ações" class="text-end">
              <button class="btn btn-sm btn-outline-primary" onclick="abrirDespesa(${d.ID})" aria-label="Editar despesa ${d.descricao}">
                <i class="bi bi-pencil-square"></i> Editar
              </button>
            </td>
          </tr>`;
        }
        table.tBodies[0].innerHTML =
          itens ||
          `<tr><td colspan="3" class="text-center text-secondary py-3">Sem despesas</td></tr>`;
      }

      function abrirDespesa(id) {
        const ID_viagem = document.getElementById("id").value;
        const popup = document.getElementById("popup");
        popup.innerHTML = `
          <h2 id="popup-title" class="h5 mb-3">Cadastro de despesa</h2>
          <form name="despesa" novalidate>
            <div class="row g-3">
              <input type="hidden" name="method" id="method" value="post">
              <input type="hidden" name="id" id="id">
              <input type="hidden" name="ID_viagem" id="ID_viagem" value="${ID_viagem}">
              <div class="col-12 col-md-8">
                <label for="descricao" class="form-label">Descrição</label>
                <input name="descricao" id="descricao" type="text" class="form-control" placeholder="Descrição da despesa">
              </div>
              <div class="col-12 col-md-4">
                <label for="valor" class="form-label">Valor</label>
                <div class="input-group">
                  <span class="input-group-text" aria-hidden="true">R$</span>
                  <input name="valor" id="valor" type="number" step="any" class="form-control" placeholder="0,00" inputmode="decimal">
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button class="btn btn-primary" type="button" onclick="salvarDespesa()" aria-label="Salvar despesa">Salvar</button>
            </div>
          </form>
          <button class="close btn btn-sm btn-light" onclick="closePopup()" aria-label="Fechar">X</button>
        `;
        if (!!id) {
          document.querySelector(`form[name="despesa"] #id`).value = id;
          document.querySelector(`form[name="despesa"] #method`).value = "put";
          const desp = (window.viagemAEditar?.despesas || []).find(
            (d) => d.ID == id
          );
          if (desp) {
            document.querySelector(`form[name="despesa"] #descricao`).value =
              desp.descricao;
            document.querySelector(`form[name="despesa"] #valor`).value =
              desp.valor;
          }
        }
        popup.style.display = "block";
        popup.setAttribute("aria-hidden", "false");
        popup.focus();
        const first = popup.querySelector("#descricao");
        if (first) first.focus();
      }
      function closePopup() {
        const popup = document.getElementById("popup");
        popup.style.display = "none";
        popup.setAttribute("aria-hidden", "true");
      }

      async function salvarDespesa() {
        loadingStart();
        const descricao = document.querySelector(
          `form[name="despesa"] #descricao`
        ).value;
        const ID_viagem = document.querySelector(
          `form[name="despesa"] #ID_viagem`
        ).value;
        const id = document.querySelector(`form[name="despesa"] #id`).value;
        const valor = document.querySelector(
          `form[name="despesa"] #valor`
        ).value;
        const cpf_user = sessionStorage.getItem("user");
        const method = document.querySelector(
          `form[name="despesa"] #method`
        ).value;
        const path = method === "put" ? `/despesa/${id}` : "/despesa";
        try {
          const r = await window.__AUTH__.callApi(path, {
            method,
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              ID_despesa: id,
              descricao,
              valor,
              ID_viagem,
              cpf_user,
            }),
          });
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (r.status == 400) {
            let { message } = await r.json().catch(() => ({}));
            exibirMensagemDeAviso(slotAvisos, message || "Dados inválidos.");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível salvar a despesa"
            );
            return;
          }
          exibirMensagemDeSucesso(slotAvisos, "Despesa salva");
          closePopup();
          await preencheTabelaDespesas(ID_viagem);
        } catch {
          exibirMensagemDeAviso(slotAvisos, "Erro ao salvar a despesa");
        } finally {
          loadingStop();
        }
      }

      async function excluirViagem(id) {
        if (
          !window.confirm(
            "Tem certeza que deseja excluir essa viagem? Essa operação é irreversível."
          )
        )
          return;
        try {
          loadingStart();
          const r = await window.__AUTH__.callApi(`/viagem/${id}`, {
            method: "delete",
          });
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível excluir essa viagem"
            );
            return;
          }
          alert("Excluído com sucesso");
          window.__AUTH__.goTo("/viagens");
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível excluir essa viagem"
          );
        } finally {
          loadingStop();
        }
      }

      document
        .querySelector("form")
        .addEventListener("submit", (e) => e.preventDefault());

      async function salvarViagem() {
        loadingStart();
        const method = document.getElementById("method").value;
        const id = document.getElementById("id").value;
        const solicitante = document.getElementById("solicitante").value;
        const origem = document.getElementById("origem").value;
        const destino = document.getElementById("destino").value;
        const cpf_motorista = document.getElementById("motorista").value;
        const placa = document.getElementById("placa").value;
        const data_viagem = document.getElementById("data").value;
        const valor = document.getElementById("valor").value;
        const nf = document.getElementById("nf").value;
        const carga = document.getElementById("carga").value;
        const path = method === "put" ? `/viagem/${id}` : "/viagem";
        const cpf_user = sessionStorage.getItem("user");
        try {
          const r = await window.__AUTH__.callApi(path, {
            method,
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              solicitante,
              origem,
              destino,
              cpf_motorista,
              placa,
              data_viagem,
              valor,
              nf,
              carga,
              cpf_user,
            }),
          });
          if (r.status == 401) {
            alert("login expirado");
            window.__AUTH__.goTo("/login");
            return;
          }
          if (r.status == 400) {
            let { message } = await r.json().catch(() => ({}));
            exibirMensagemDeAviso(slotAvisos, message || "Dados inválidos.");
            return;
          }
          if (!r.ok) {
            exibirMensagemDeAviso(
              slotAvisos,
              "Não foi possível salvar os dados dessa viagem"
            );
            return;
          }

          exibirMensagemDeSucesso(slotAvisos, "Viagem salva");
          const modal = new bootstrap.Modal(
            document.getElementById("modal-pos-salvar"),
            {}
          );
          modal.show();
          habilitaBtnDespesa();
        } catch {
          exibirMensagemDeAviso(
            slotAvisos,
            "Não foi possível cadastrar a viagem"
          );
        } finally {
          loadingStop();
        }
      }

      (async function onLoad() {
        loadingStart();
        await buscarMotoristas();
        await buscarVeiculos();
        const qs = new URLSearchParams(window.location.search);
        if (!!qs.get("id")) await editarViagem(qs.get("id"));
        preencheVeiculo();
        loadingStop();
      })();
    </script>

    <script src="../public/header.js" defer></script>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>

    <div
      class="modal"
      id="modal-pos-salvar"
      tabindex="-1"
      aria-labelledby="modal-title"
      aria-modal="true"
      role="dialog"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modal-title">Salvo com sucesso</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            <p>O que você deseja fazer?</p>
            <p>Voltar para a listagem de viagens ou cadastrar uma nova?</p>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button
              type="button"
              class="btn btn-secondary d-flex"
              onclick="window.__AUTH__.goTo('/viagens')"
            >
              Voltar para a listagem
            </button>
            <button
              type="button"
              class="btn btn-primary d-flex"
              onclick="window.__AUTH__.goTo('/viagem')"
            >
              Cadastrar novo
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
